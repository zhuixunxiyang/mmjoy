**Цифровые датчики для MJoy**<br>
<br>
Собственно, началось с того, что в сентябре 2013 года участник авиасимуляторных форумов YoZHeG обратился к разработчику прошивки MMJoy mega_mozg_13 с предложением создать цифровые датчики для контроллеров Mjoy. Идея состояла в том, что подобные датчики можно будет использовать на значительном расстоянии от контроллера. К примеру, в педалях под столом. В свою очередь, mega_mozg_13 попросил меня сделать железную часть датчиков. В первые же минуты мы выбрали подходящий АЦП — MCP3201. Для удобства прототипирования - вариант в корпусе DIP-8. Этот чип имеет один АЦП с разрешением 12 бит, интерфейс SPI, использует питание 2,7-5,5 В и стоит $2-3.<br>
<br>
<br>
Без особого труда MCP3201 был найден в продаже.<br>
Для экспресс оценки этот АЦП был подключен к микроконтроллерному модулю BASIC STAMP 2 в дебаг режиме с потенциометром 10 кОм в качестве источника сигнала. Сразу стало ясно, что выбор сделан удачный (в смысле четкости работы устройства, отсутствия помех, нетребовательности к обвеске и монтажу). Испытания выявили исключительную важность подключения вывода In- к земле. В этом случае работает система подавления помех, примерно аналогичная балансному входу в звукоусилительной аппаратуре, где наводки инвертируются и вычитаются из загрязненного сигнала, оставляя его чистым. Напротив, обвеска в форме помехоподавляющих конденсаторов не играет здесь существенной роли. Можно вполне ею принебречь. Двенадцатиразрядный АЦП дает на выходе 4096 отсчетов.<br>
<br>
<br><b>Кабели и разъемы.</b><br>
Одним словом, сам АЦП не обещал серьезных схемотехнических затруднений. Чего нельзя сказать о конструктивных особенностях устройства. SPI интерфейс использует три сигнальных линии. Кроме того к датчику необходимо подвести питание и землю. Т.е. всего кабель, соединяющий датчик с контроллером, должен нести пять проводов. Сперва рассматривались варианты использования телефонных и сетевых разъемов, но они достаточно громоздки в сравнении с размерами контроллера и датчиков. И соответствующие кабели слишком толстые и жесткие. После недолгих мучений с перебором вариантов было решено ничего нового не изобретать. В самом деле, очень удобно использовать те же, ставшие традиционными для Mjoy, штыревые разъемы. А в качестве оптимального кабеля для аналоговых датчиков я уже давно выбрал косичку из тонкого провода МГТФ 0.03 (диаметр в изоляции 0.4 мм). Только, для цифровых датчиков кабель-косичка плетется не из трех, а из пяти проводов. Рекомендации по плетению кос из пяти прядей легко нашлись поиском в Интернете.<br>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_01_cables.png' /><br>
<i>Фото 1. Косичка из пяти проводов МГТФ 0.03 и два провода витой пары для сравнения.</i><br>
<br>
После того, как конструктивные трудности остались позади, было собрано три генерации цифровых потенциометров, две генерации цифрового магниторезистора и один вариант цифрового датчика Холла. Датчики монтировались на макетной плате со сквозными круглыми контактными площадками (шаг 2,5 мм).<br>
<br><br><b>Цифровой потенциометр.</b><br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_02_res_mcp3201.png' /><br>
<i>Фото 2. Цифровой потенциометр.</i>
<br>
<br>
В процессе работы датчик с потенциометром постепенно уменьшался в размерах, и в итоге АЦП безо всякой макетной платы был припаян к выводам переменного резистора. В простейшем случае можно просто попарно соединить ножки микросхемы 1-8 (образцовое напряжение, питание) и 3-4 (In-, земля). После этого АЦП припаивается своим аналоговым входом (выводом 2, In+) к центральному ползунковому контакту резистора, и соседними выводами (1 – vref,vdd и 3 In-, vss) к крайним контактам резистора. Работает такая связка безупречно. Дрожания в DXTweak2 не наблюдается. (Резистор <a href='https://code.google.com/p/mmjoy/source/detail?r=2'>R2</a> на датчике используется для подтягивания к питанию входа встроенного АЦП микроконтроллера, который при подключении цифрового датчика не используется).<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_03_scheme_s.png' /><br>
<i>Фото 3. Схема цифрового потенциометра.</i>
<br><br><b>Цифровой магниторезистор.</b><br>
В основу магниторезистора была положена самая распространенная и простая схема на KMZ41 и MCP601.(1)<br>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_04_magres1_t.png' /><br>
<i>Фото 4. Цифровой магниторезистор первой генерации вид с наружной стороны. Единичный штыревой разъем - для снятия аналогового сигнала при настройке. Пятиштыревой разъем для подключения к контроллеру.</i>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_05_magres1_b.png' /><br>
<i>Фото 5. Цифровой магниторезистор первой генерации вид с внутренней стороны.</i>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_06_magres2_t.png' /><br>
<i>Фото 6. Цифровой магниторезистор второй генерации вид с наружной стороны.</i>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_07_magres2_b.png' /><br>
<i>Фото 7. Цифровой магниторезистор второй генерации вид с внутренней стороны.</i>
<br>
<br>
Этот датчик также собирался на макетной плате. Может показаться, что некоторую проблему здесь представляет монтаж KMZ41 в корпусе SO8. Но проблема эта мнимая. К чипам в подобных корпусах (собственно, в любых) можно прекрасно применять приемы навесного монтажа. И не требуется никакого экзотического оборудования. Конечно, это не означает, что можно взять дедовский паяльник с жалом толщиной 25 мм и наутро после веселой ночи лихо запаять SO8 в монтажную плату. Все таки, потребуется минимальная подготовка.<br>
<br><br><b>Отступление о пайке KMZ41 и подобной мелочи.</b><br>
Нижеследующая инструкция не претендует на революционность и адресована тем, кого смущает монтаж SO и подобных чипов.<br>
<br>
В первую очередь, не следует держать ни сам чип, ни припаиваемый к нему проводник руками. Надо использовать третьи руки, иначе - зажимы крокодил на подставках (или пластилин, или … можно долго продолжать). Несколько сантиметров провода зажать в другом крокодиле. Провод совместить с выводом чипа.<br>
<br>
<br>
Чем и как паять? Паяльник. Мой паяльник имеет керамический нагревательный элемент и стандартное коническое жало. Но, подозреваю, что сгодится любой. В былые времена я пробовал применять для подобных работ старые бытовые паяльники с массивным медным жалом, просто накручивая на последнее медную проволоку диаметром 1 мм, и паял свободно торчащим ее концом, выключая питание паяльника на момент пайки, на всякий случай. Температура не должна быть слишком низкой. У меня стоит 400 градусов по Цельсию. Как ни странно, при низкой температуре больше шансов перегреть компоненты, потому что приходится долго прикасаться паяльником к деталям для их нагрева. А контакт с деталями лучше сделать кратковременным, доли секунды.<br>
<br>
<br>
Важно, чтобы инструмент был хорошо расположен на столе для быстрого удобного доступа. Паяльник в надежной подставке. Жидкий флюс в устойчивом флаконе, заранее открытом. Припой размотан. На столе закреплена мокрая тряпочка (оптимально влажная ацетатная губка). При совершении паяльником активных действий кисть руки лучше не держать на весу, а класть на опору. Паяльник двигать пальцами. Желательно всю процедуру пайки сначала отрепетировать (с холодным паяльником). Раствор канифоли можно приготовить на основе этилового или пропилового спирта. Допустимо на 4 объема спирта 1 объем канифоли. Это, как понравится. Припой лучше брать 61% олова, 39% свинца (это теоретически, у меня любимый 60/40). Припой такого состава при остывании резко переходит из жидкого состояния в твердое, практически минуя промежуточные состояния. Если есть выбор, из нескольких припоев, то надо покапать ими на стол и выбрать тот, который застывает гладкими блестящими капельками.<br>
<br>
<br>
Жало паяльника залуживается. Щедро смачивается припоем и припой растирается по жалу о тряпочку, пока рабочая часть не станет блестящей. Потом жало тщательно обтирается. Слегка касаемся конца проволочки припоя. Смотрим, какого размера капля на жале. Грубо говоря, нам нужна капля около полумиллиметра. Если капля сильно большая, или маленькая, то стираем ее о тряпку и повторяем попытку. (В реальности все это очень быстро происходит.) Капля нужного размера на жале. Быстренько тонкой кисточкой наносим капельку спиртовой канифоли на контакт и на мгновение касаемся каплей. Как надолго? Примерно на время пшика флюса. Все. Контакт запаян.<br>
<br>
<br>
И вот, KMZ41 с четырьмя проволочками у нас в руках. Прикладываем его к макетке. Выбираем места для пайки. Мешающие контактные площадки под выводами микросхемы убираем высверливанием. Когда монтируем, то прижимаем провод пинцетом к плате ближе к чипу для отведения тепла, что бы не отпаялся от KMZ.<br>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_08_kmz41.png' /><br>
<i>Фото 8. KMZ41 на макетке.</i>
<br>
<br>
Несколько занудно, но занудство здесь уместно.<br>
<br>
<br>
Магниторезистор подключается к по той же схеме, что и потенциометр. Вывод Vout MCP601 соединяется с In+ MCP3102. Естественно, желательно это соединение сделать по возможности коротким.<br>
<br>
<br>
В DXTweak2 магниторезистор временами показывает ничтожные флуктуации выходного значения размахом в 1 единицу.<br>
<br><br><b>Цифровой датчик Холла.</b><br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_09_hall_mcp3201_t.png' /><br>
<i>Фото 9. Цифровой датчик Холла с наружной стороны.</i>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_10_hall_mcp3201b.png' /><br>
<i>Фото10. Цифровой датчик Холла с внутренней стороны.</i>
<br>
<br>
В аналоговом варианте Холлы в качестве датчиков работают вполне нормально, но слабонервным показания DXTweak2 при этом лучше не видеть. Пресловутая дрожь осей! На моем контроллере она происходит стабильно с размахом в одну единицу и с большой частотой. В цифровом варианте датчика, где разрешение увеличивается в четыре раза, соответственно и дрожь усиливается во столько же, что пробуждает нездоровый перфекционизм. (Если терпеть подобное зрелище в DXTweak2 нет сил, то соедините сигнальный вывод датчика Холла с землей электролитическим конденсатором 1мкФ. При этом следует иметь в виду, что некоторые виртуальные пилоты субъективно отмечают увеличение времени реакции управления при наличии конденсатора на сигнале.) На практике дрожание на управлении не негативно не сказывается. Холл, как и другие датчики, подключается сигнальным выводом (output) к входу In+ MCP3201.<br>
<br>
<br>
<b>Потребление тока цифровыми датчиками.</b>
<br>
С датчиком Холла SS495A и MCP3201 – 6,9 мА<br>
С магниторезистором KMZ41, MCP601, MCP3201 – 2,3 мА<br>
C потенциометром 10K и MCP3201 – 0.4 мА.<br>
<br><br><b>Модификация контроллера для использования с цифровыми датчиками.(2)</b><br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/Mjoy_2011plus.png' /><br>
<i>Фото 11. Схема подключения цифровых датчиков к контроллеру. Для примера показаны только датчики 0 и 1. Датчики 2-5 могут быть подключены сходным образом. (<b>Редакция 16 декабря 2013 г.</b> Внимание! Схема отредактирована в соответствии с прошивкой v20131216. Для датчиков MCP3202, MCP3204, MCP3208, которые поддерживаются , начиная с этой прошивки, необходим шестой контакт разъема для подключения канала Din датчика.).</i>
<br>
<br>
Каждый датчик соединяется с контроллером пятью проводами. Хорошая новость состоит в том, что четыре из этих пяти проводов — общие для всех цифровых датчиков. Индивидуально на датчики подается только сигнал CS. Этот сигнал снимается с выводов АЦП микроконтроллера. Цифровые и аналоговые датчики могут быть альтернативно использованы в любых сочетаниях. Подключение цифровых датчиков на функциональности кнопок никак не сказывается.<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_12_pcb_ds_t_signed.png' /><br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_13_pcb_ds_b.png' /><br>
<i>Фото 12, 13. MJoy8 схема Mercury 2011, модифицированный для подключения цифровых датчиков. Вид сверху, снизу.</i>
<br>
<br>
<b>Модификация аналоговых датчиков для цифрового подключения.</b>
<br>
<br>
<img src='https://mmjoy.googlecode.com/svn/wiki/extadc_14_mcp3201connect.png' /><br>
<i>Фото 14. Простейшая схема для добавления цифрового выхода к аналоговым датчикам на MCP3201.</i>
<br>
<br>
Еще раз отмечу, что MCP3201 чрезвычайно удобная микросхема. Она содержит в себе все необходимое для полноценной работы АЦП, не требует настройки и добавочных компонентов. Достаточно подключить выход аналогового датчика к ее входу, и можно снимать информацию. Кроме того, встроенная система подавления помех впечатляет! Легко убедиться в ее эффективности. Достаточно отключить вывод In-. На фото приведена схема простейшего способа подключения MCP3201 к самым разным датчикам. Ставятся две перемычки. +5V (1, 8), GND (3, 4), Analog signal (2) соединяется с датчиком. +5V (1, 8), GND (3, 4), CS(5), Dout (6), CLS (7) соединительным кабелем подключаются к контроллеру. (Для использования в составе MMJoy рекомендуется еще установить на выход АЦП подтяжечный резистор 10кОм между +5V и CS).<br>
<br><br><b>Первые впечатления.</b><br>
Использованием цифровых датчиков предполагалось (1) добиться возможности отдаления датчика от контроллера (2) повысить разрешение датчика.<br>
<br>
<br>
Что касается отдаления, то задание состояло в обеспечении полной функциональности на удалении 250 см от контроллера. Этим требованиям описанные выше датчики соответствуют. То есть подключение их к контроллеру 5-жильным шлейфом длиной 250 см не влияет на их работу. Это не может не радовать. Но, справедливости ради, отмечу, что простой резистор на моем контроллере в аналоговом режиме тоже работает хорошо, будучи подключенным 170 см проводом безо всяких хитростей. Планирую в будущем провести более корректное сравнение.<br>
<br>
<br>
Теперь про разрешение. Оно повысилось в четыре раза по сравнению с аналоговым вариантом (было 1024, стало 4096). Яркого различия в пилотировании виртуальных самолетов, честно говоря, я не увидел (использовался джойстик с точной механикой на подшипниках, симуляторы Ил-2 4.12.1 и Rise of Flight1.031). Как лучше описать подобное разрешение? При цифровом подключении потенциометра с рабочим углом 300 градусов и ручкой диаметром 40 мм выставить значение данных в джойтестере удается только с точностью до 5ти единиц. И то, очень нежными движениями пальцев. Настолько же нежно для смещения на 5 отсчетов придется сдвигать 20 сантиметровую ручку джойстика с углом хода 60 градусов. Думаю, добиться перемещения ручки с точностью в один отсчет — невозможно. (Хотя, жизнь порой опровергает и не такие утверждения). К тому же запас точности не вреден. А разрешение в 1024 отсчета определенно достижимо человеком и, очевидно, может быть превзойдено при достаточной тренировке и способностях. Иными словами, может оказаться и недостаточным для некоторых.<br>
<br>
Однако, совершенно не вызывает сомнения, что запас разрешающей способности, безусловно полезен для всякого рода калибровок, как ручных, так и автоматизированных, и создает поле для работы над расширением функциональности прошивки в этом направлении.<br>
<br>
<br>
<b>2013.09.30(с)china</b><br>
<br>
<hr />
<br>
<br>

<br><br><b>(1) Оригинальные схемы магрез'а</b><br>
<br>(теория с форумов сухой.ру, версия реализации пользователем GVL)<br>
<a href='https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_MM_44-22.GIF'>https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_MM_44-22.GIF</a><br>
схема печатной платы<br>

<a href='https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_MM_44-22.lay6'>https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_MM_44-22.lay6</a><br>
схема печатной платы(Sprint Layout6 )<br>

<a href='https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_Setup.doc'>https://mmjoy.googlecode.com/svn/wiki/MagRez_GVL_Setup.doc</a><br>
пояснения сборки и настройки от GVL<br>

<br><br><b>(2)Модификация контроллера для использования с цифровыми датчиками.</b><br>
Подключение внешних АЦП работает начиная с версии [v2013.09.20]<br>
<b>ВНИМАНИЕ. так как опрос внешних АЦП переводит ножки контроллера в режим вывода нельзя неиспользуемые ножки заземлять напрямую перемычкой (или напрямую подтягивать к питанию) - используйте резистор 10Ком(от земли/или питания на неиспользуемую ножку, вместо перемычки)</b><br>
<b>(с)mega_mozg</b><br>